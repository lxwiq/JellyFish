name: Build Android & Windows

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

# Cancel previous runs on same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ============================================
  # ANDROID BUILD
  # ============================================
  build-android:
    name: Android ${{ matrix.build_type }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        build_type: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && fromJSON('["release"]') || github.event.inputs.build_type && fromJSON(format('["{0}"]', github.event.inputs.build_type)) || fromJSON('["debug"]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Debug build
      - name: Build Debug APK
        if: matrix.build_type == 'debug'
        run: ./gradlew :composeApp:assembleDebug --no-daemon

      # Release build (signed)
      - name: Decode Keystore
        if: matrix.build_type == 'release'
        env:
          ENCODED_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$ENCODED_KEYSTORE" | base64 -d > keystore.jks

      - name: Build Release APK
        if: matrix.build_type == 'release'
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        run: |
          ./gradlew :composeApp:assembleRelease --no-daemon \
            -Pandroid.injected.signing.store.file="$(pwd)/keystore.jks" \
            -Pandroid.injected.signing.store.password="$SIGNING_STORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$SIGNING_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$SIGNING_KEY_PASSWORD"

      - name: Build Release AAB (for Play Store)
        if: matrix.build_type == 'release'
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        run: |
          ./gradlew :composeApp:bundleRelease --no-daemon \
            -Pandroid.injected.signing.store.file="$(pwd)/keystore.jks" \
            -Pandroid.injected.signing.store.password="$SIGNING_STORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$SIGNING_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$SIGNING_KEY_PASSWORD"

      - name: Clean up keystore
        if: always() && matrix.build_type == 'release'
        run: rm -f keystore.jks

      # Upload artifacts
      - name: Upload Debug APK
        if: matrix.build_type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: jellyfish-android-debug
          path: composeApp/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: Upload Release APK
        if: matrix.build_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: jellyfish-android-release-apk
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload Release AAB
        if: matrix.build_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: jellyfish-android-release-aab
          path: composeApp/build/outputs/bundle/release/*.aab
          retention-days: 30

  # ============================================
  # WINDOWS BUILD
  # ============================================
  build-windows:
    name: Windows ${{ matrix.build_type }}
    runs-on: windows-latest
    timeout-minutes: 45

    strategy:
      matrix:
        build_type: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && fromJSON('["release"]') || github.event.inputs.build_type && fromJSON(format('["{0}"]', github.event.inputs.build_type)) || fromJSON('["debug"]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      # Android SDK required even for desktop builds (plugin applies to project)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      # Debug build
      - name: Build Debug MSI
        if: matrix.build_type == 'debug'
        run: ./gradlew :composeApp:packageMsi --no-daemon

      # Release build
      - name: Build Release MSI
        if: matrix.build_type == 'release'
        run: ./gradlew :composeApp:packageReleaseMsi --no-daemon

      # Also build uber JAR as portable alternative
      - name: Build Uber JAR
        shell: pwsh
        run: |
          $task = if ("${{ matrix.build_type }}" -eq "release") { "packageReleaseUberJarForCurrentOS" } else { "packageUberJarForCurrentOS" }
          ./gradlew ":composeApp:$task" --no-daemon

      # Upload artifacts
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: jellyfish-windows-${{ matrix.build_type }}-msi
          path: composeApp/build/compose/binaries/main*/msi/*.msi
          retention-days: ${{ matrix.build_type == 'release' && 30 || 7 }}

      - name: Upload Uber JAR
        uses: actions/upload-artifact@v4
        with:
          name: jellyfish-windows-${{ matrix.build_type }}-jar
          path: composeApp/build/compose/jars/*.jar
          retention-days: ${{ matrix.build_type == 'release' && 30 || 7 }}

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  release:
    name: Create Release
    needs: [build-android, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: jellyfish-*-release-*

      - name: Display structure
        run: ls -R artifacts/

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Prepare release files
        run: |
          mkdir -p release
          VERSION="${GITHUB_REF#refs/tags/v}"

          # Android
          find artifacts -name "*.apk" -exec cp {} "release/JellyFish-${VERSION}-android.apk" \; 2>/dev/null || true
          find artifacts -name "*.aab" -exec cp {} "release/JellyFish-${VERSION}-android.aab" \; 2>/dev/null || true

          # Windows
          find artifacts -name "*.msi" -exec cp {} "release/JellyFish-${VERSION}-windows.msi" \; 2>/dev/null || true
          find artifacts -name "*.jar" -exec cp {} "release/JellyFish-${VERSION}-portable.jar" \; 2>/dev/null || true

      - name: Generate checksums
        working-directory: release
        run: sha256sum * > SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: JellyFish ${{ github.ref_name }}
          draft: true
          generate_release_notes: true
          files: |
            release/*
